<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>阿簽被校園霸凌情形模擬器</title>
    <style>
        :root {
            --bg-dark: #0d0d0d;
            --accent-simple: #ff4d4d;
            --accent-hard: #bf55ff;
            --accent-friend: #00a2ff;
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-dark);
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow-x: hidden;
        }

        /* 全螢幕結算層 */
        #overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.98);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 40px;
        }
        #overlay-text { font-size: 2.2rem; font-weight: bold; line-height: 1.6; }

        /* 小黑帽獨立按鈕 */
        #friend-unlock-btn {
            display: none; 
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 120px;
            height: 120px;
            background: #0a1a2a;
            border: 3px solid var(--accent-friend);
            border-radius: 50%;
            cursor: pointer;
            z-index: 1000;
            color: var(--accent-friend);
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 0 25px var(--accent-friend);
            transition: all 0.3s;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .tab-container { display: flex; width: 100%; max-width: 600px; margin-top: 20px; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; background: #222; border: 1px solid #444; font-weight: bold; }
        .tab.active-simple { background: #2a0a0a; border-bottom: 3px solid var(--accent-simple); color: var(--accent-simple); }
        .tab.active-hard { background: #1a0a2a; border-bottom: 3px solid var(--accent-hard); color: var(--accent-hard); }

        .game-content { display: none; flex-direction: column; align-items: center; width: 100%; padding: 20px; margin-top: 20px; }
        .game-content.active { display: flex; }

        .board { display: grid; grid-template-columns: repeat(3, 100px); grid-template-rows: repeat(3, 100px); gap: 10px; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .cell { width: 100px; height: 100px; background-color: #1a1a1a; display: flex; align-items: center; justify-content: center; font-size: 3.5rem; cursor: pointer; border: 1px solid #333; }
        
        #simple-ver .board { background-color: #3a1a1a; }
        #hard-ver .board { background-color: #2a1a3a; }
        #friend-ver .board { background-color: #1a2a3a; }

        .status-panel { text-align: center; font-size: 1.1rem; line-height: 1.8; }
        .disclaimer { margin-top: auto; padding: 20px; color: #555; font-size: 0.9rem; text-align: center; width: 100%; border-top: 1px solid #333; }
        select { padding: 5px; background: #222; color: #fff; border: 1px solid #444; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="overlay"><div id="overlay-text"></div></div>

    <div id="friend-unlock-btn" onclick="enterFriendMode()"></div>

    <div id="main-nav" class="tab-container">
        <div id="tab-s" class="tab active-simple" onclick="switchGame('simple')">簡單版 (熙熙)</div>
        <div id="tab-h" class="tab" onclick="switchGame('hard')">困難版 (小恩怨)</div>
    </div>

    <div id="simple-ver" class="game-content active">
        <h1 style="color:var(--accent-simple)">阿簽被校園霸凌模擬器--簡單版</h1>
        <div class="status-panel">
            對手：熙熙 | 程度：
            <select id="diff-s" onchange="resetGame('s')">
                <option value="easy">唐寶</option>
                <option value="normal">一般</option>
                <option value="hard" selected>巔峰</option>
                <option value="balance">平衡</option>
            </select>
            <div id="turn-s">輪到：阿簽 (O)</div>
        </div>
        <div class="board" id="board-s"></div>
    </div>

    <div id="hard-ver" class="game-content">
        <h1 style="color:var(--accent-hard)">阿簽被校園霸凌模擬器--困難版</h1>
        <div class="status-panel">
            對手：小恩怨 | 程度：
            <select id="diff-h" onchange="resetGame('h')">
                <option value="easy">靠自己玩</option>
                <option value="normal">有人協助</option>
                <option value="cheat" selected>我已受夠</option>
                <option value="balance">你跟我半斤八兩</option>
            </select>
            <div id="turn-h">輪到：阿簽 (O)</div>
        </div>
        <div class="board" id="board-h"></div>
    </div>

    <div id="friend-ver" class="game-content">
        <button onclick="exitFriendMode()" style="align-self: flex-start; background:none; border:1px solid #444; color:#888; cursor:pointer;">← 返回</button>
        <h1 style="color:var(--accent-friend)">校園的一道光--小黑帽</h1>
        <div class="status-panel">
            對手：小黑帽 | 程度：
            <select id="diff-f" onchange="resetGame('f')">
                <option value="easy">簡單</option>
                <option value="normal">困難</option>
                <option value="top" selected>校排一</option>
                <option value="rand">隨便</option>
            </select>
            <div id="turn-f">輪到：阿簽 (O)</div>
        </div>
        <div class="board" id="board-f"></div>
    </div>

    <div class="disclaimer"><b>對話內容皆真實發生過，且本人不需付出任何法律責任或懲處</b></div>

    <script>
        const state = {
            s: { board: Array(9).fill(""), active: true, p1Starts: true, player: "O", winStreakX: 0 },
            h: { board: Array(9).fill(""), active: true, p1Starts: true, player: "O" },
            f: { board: Array(9).fill(""), active: true, p1Starts: true, player: "O" }
        };
        let totalGames = 0;
        let friendUnlocked = false;

        const winMsgs = { 
            s: "阿簽，你打這什麼外掛？準備跟迎旗約談一小時", 
            h: "你太兇了，我要殺了你！你一定下地獄，誰叫你要惹我" 
        };
        const loseMsgs = { 
            s: "沒有人要理你，沒有人要跟你好，誰叫你打這麼菜", 
            h: "我贏了，所以我可以生氣！你看，阿簽就是很愛亂打小報告" 
        };
        const drawMsgs = { 
            s: "平手又不是你贏，你是有多厲害", 
            h: "你知道我爸爸是誰嗎？他是本校家長會長！你對本校家長會長的女兒不敬，竟然讓我平手而不是贏，你死定了！" 
        };
        const friendMsgs = ["你真的很厲害，絕對可以撐過這段霸凌", "沒關係！我永遠支持你", "我們雙贏"];

        function initBoards() {
            ['s', 'h', 'f'].forEach(t => {
                const b = document.getElementById(`board-${t}`);
                b.innerHTML = '';
                for(let i=0; i<9; i++) {
                    let c = document.createElement('div');
                    c.className = 'cell';
                    c.onclick = () => makeMove(t, i);
                    b.appendChild(c);
                }
            });
        }

        function switchGame(type) {
            document.querySelectorAll('.game-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.className = 'tab');
            document.getElementById(`${type}-ver`).classList.add('active');
            const tabCode = type === 'simple' ? 's' : 'h';
            document.getElementById(`tab-${tabCode}`).classList.add(`active-${type}`);
        }

        function enterFriendMode() {
            document.querySelectorAll('.game-content').forEach(el => el.classList.remove('active'));
            document.getElementById('main-nav').style.display = 'none';
            document.getElementById('friend-ver').classList.add('active');
            resetGame('f');
        }

        function exitFriendMode() {
            document.getElementById('main-nav').style.display = 'flex';
            switchGame('simple');
        }

        function makeMove(t, idx) {
            const g = state[t];
            if (!g.active || g.board[idx] !== "" || g.player !== "O") return;
            
            let diff = document.getElementById(`diff-${t}`).value;
            // 原版作弊邏輯
            if((t === 'h' && diff === 'cheat') || (t === 's' && g.winStreakX >= 15)) {
                if(checkWin(g.board, "O") && Math.random() > 0.3) {
                    // 玩家的落子被「無視」或抹除
                } else {
                    g.board[idx] = "O";
                }
            } else {
                g.board[idx] = "O";
            }
            
            render(t);
            if (checkEnd(t, "O")) return;
            g.player = "X";
            document.getElementById(`turn-${t}`).innerText = `輪到：${t==='s'?'熙熙':(t==='h'?'小恩怨':'小黑帽')} (X)`;
            setTimeout(() => aiAction(t), 500);
        }

        function aiAction(t) {
            const g = state[t];
            const diff = document.getElementById(`diff-${t}`).value;
            let move;

            if (diff === "hard" || diff === "cheat" || diff === "top") {
                move = minimax(g.board, "X").index;
            } else if (diff === "easy") {
                move = getRand(g.board);
            } else {
                move = getSmart(g.board, "O") || getRand(g.board);
            }

            if (move !== undefined) g.board[move] = "X";
            render(t);
            if (checkEnd(t, "X")) return;
            g.player = "O";
            document.getElementById(`turn-${t}`).innerText = "輪到：阿簽 (O)";
        }

        function checkEnd(t, p) {
            const g = state[t];
            let msg = "";
            if (checkWin(g.board, p)) {
                if (t === 'f') msg = (p === "O" ? friendMsgs[0] : friendMsgs[1]);
                else msg = (p === "O" ? winMsgs[t] : loseMsgs[t]);
                if(t === 's') { if(p === 'X') g.winStreakX++; else g.winStreakX = 0; }
            } else if (g.board.every(c => c !== "")) {
                msg = (t === 'f' ? friendMsgs[2] : drawMsgs[t]);
                if(t === 's') g.winStreakX++;
            }

            if (msg !== "") {
                g.active = false;
                totalGames++;
                showOverlay(msg, t);
                checkUnlock();
                return true;
            }
            return false;
        }

        function showOverlay(text, t) {
            const ov = document.getElementById('overlay');
            const ot = document.getElementById('overlay-text');
            ot.innerText = text;
            ot.style.color = t === 's' ? 'var(--accent-simple)' : (t === 'h' ? 'var(--accent-hard)' : 'var(--accent-friend)');
            ov.style.display = 'flex';
            setTimeout(() => {
                ov.style.display = 'none';
                resetGame(t);
            }, 5000);
        }

        function checkUnlock() {
            if (totalGames >= 15 && !friendUnlocked) {
                friendUnlocked = true;
                const btn = document.getElementById('friend-unlock-btn');
                btn.style.display = 'flex';
                btn.innerHTML = "你沒有錯<br>不應該受他們的折磨";
            }
        }

        function checkWin(b, p) { return [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]].some(c => b[c[0]]===p && b[c[1]]===p && b[c[2]]===p); }
        function getRand(b) { let a = b.map((v, i) => v === "" ? i : null).filter(v => v !== null); return a[Math.floor(Math.random() * a.length)]; }
        function getSmart(b, opp) {
            for (let c of [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]]) {
                let v = [b[c[0]], b[c[1]], b[c[2]]];
                if (v.filter(x => x === opp).length === 2 && v.filter(x => x === "").length === 1) return c[v.indexOf("")];
            }
            return null;
        }

        function minimax(b, p) {
            let a = b.map((v,i) => v===""?i:null).filter(v=>v!==null);
            if (checkWin(b, "O")) return {score: -10};
            if (checkWin(b, "X")) return {score: 10};
            if (a.length === 0) return {score: 0};
            let moves = [];
            for (let i of a) {
                b[i] = p;
                let res = minimax(b, p === "X" ? "O" : "X");
                moves.push({index: i, score: res.score});
                b[i] = "";
            }
            return p === "X" ? moves.reduce((best, m) => m.score > best.score ? m : best) : moves.reduce((best, m) => m.score < best.score ? m : best);
        }

        function render(t) {
            const cells = document.querySelectorAll(`#board-${t} .cell`);
            state[t].board.forEach((v, i) => {
                cells[i].innerText = v;
                if(v === "X") cells[i].style.color = t === 's' ? 'var(--accent-simple)' : (t === 'h' ? 'var(--accent-hard)' : 'var(--accent-friend)');
                else cells[i].style.color = "#fff";
            });
        }

        function resetGame(t) {
            const g = state[t];
            g.board = Array(9).fill("");
            g.active = true;
            g.p1Starts = !g.p1Starts;
            g.player = g.p1Starts ? "O" : "X";
            document.getElementById(`turn-${t}`).innerText = `輪到：${g.player==="O"?'阿簽':(t==='s'?'熙熙':(t==='h'?'小恩怨':'小黑帽'))} (${g.player})`;
            if (g.player === "X") setTimeout(() => aiAction(t), 500);
            render(t);
        }

        initBoards();
    </script>
</body>
</html>
