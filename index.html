<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>阿簽反霸凌之戰</title>
    <style>
        :root {
            --bg-dark: #050505;
            --accent-normal: #bf55ff; /* 曉恩苑 */
            --accent-hard: #ff4d4d;   /* 希悉郝謗 */
            --accent-friend: #00a2ff; /* 盛旦數 */
        }

        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-dark);
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        #transition-layer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            z-index: 4000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.8s ease;
        }

        #story-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: black;
            z-index: 5000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            text-align: center;
            line-height: 1.8;
        }
        #story-content { max-width: 800px; font-size: 1.1rem; color: #ccc; margin-bottom: 30px; }
        .start-btn { padding: 15px 40px; border: 2px solid white; background: none; color: white; cursor: pointer; font-size: 1.2rem; transition: 0.3s; }
        .start-btn:hover { background: white; color: black; }

        #overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.98);
            z-index: 3000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        #overlay-text { font-size: 2.2rem; font-weight: bold; line-height: 1.6; }

        #friend-btn {
            display: none; position: fixed; bottom: 30px; right: 30px;
            width: 120px; height: 120px; background: #0a1a2a;
            border: 3px solid var(--accent-friend); border-radius: 50%;
            cursor: pointer; z-index: 1000; color: var(--accent-friend);
            font-weight: bold; text-align: center; box-shadow: 0 0 20px var(--accent-friend);
            align-items: center; justify-content: center; animation: pulse 2s infinite;
            padding: 10px; box-sizing: border-box; font-size: 0.95rem;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        .game-content { display: none; flex-direction: column; align-items: center; width: 100%; padding: 20px; margin-top: 50px; }
        .game-content.active { display: flex; }

        .board { display: grid; grid-template-columns: repeat(3, 100px); grid-template-rows: repeat(3, 100px); gap: 10px; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .cell { width: 100px; height: 100px; background-color: #1a1a1a; display: flex; align-items: center; justify-content: center; font-size: 3.5rem; cursor: pointer; border: 1px solid #333; }
        
        #normal-ver .board { background-color: #1a0a2a; }
        #hard-ver .board { background-color: #2a0a0a; }
        #friend-ver .board { background-color: #1a2a3a; }

        .status-panel { text-align: center; font-size: 1.2rem; }
        #replay-btn { display: none; padding: 10px 20px; background: white; color: black; border: none; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body onclick="checkFullScreen()">

    <div id="transition-layer"></div>

    <div id="story-overlay">
        <div id="story-content">
            2024年9月，一個患有亞斯伯格症及 ADHD 的特教生阿簽進入了【名竹國中】。<br>
            起初一切順利，直到【希悉郝謗】因嫉妒而聯合【曉恩苑】發起霸凌。<br><br>
            他們向你宣戰，要打井字棋。但是，卻賭注是你的【情緒控管】。<br>
            你必須保持冷静。崩潰就是輸掉比賽，代價就是死亡。<br>
            阿簽，你能活下來嗎？
        </div>
        <button class="start-btn" onclick="startGame()">接受挑戰 (進入全螢幕)</button>
    </div>

    <div id="overlay">
        <div id="overlay-text"></div>
        <button id="replay-btn" onclick="location.reload()">重新遊玩</button>
    </div>

    <div id="friend-btn" onclick="enterFriendMode()">盛旦樹<br>支持你</div>

    <div id="normal-ver" class="game-content">
        <h1 style="color:var(--accent-normal)">情緒生死戰：初階 (曉恩苑)</h1>
        <div class="status-panel"><div id="turn-n">輪到：阿簽 (O)</div></div>
        <div class="board" id="board-n"></div>
    </div>

    <div id="hard-ver" class="game-content">
        <h1 style="color:var(--accent-hard)">情緒生死戰：進階 (希悉郝謗)</h1>
        <div class="status-panel"><div id="turn-h">輪到：阿簽 (O)</div></div>
        <div class="board" id="board-h"></div>
    </div>

    <div id="friend-ver" class="game-content">
        <h1 style="color:var(--accent-friend)">最後的溫暖：盛旦數</h1>
        <div class="status-panel"><div id="turn-f">輪到：阿簽 (O)</div></div>
        <div class="board" id="board-f"></div>
    </div>

    <script>
        const state = {
            n: { board: Array(9).fill(""), active: true, player: "O", count: 0 },
            h: { board: Array(9).fill(""), active: true, player: "O", count: 0 },
            f: { board: Array(9).fill(""), active: true, player: "O", count: 0 }
        };

        const msgs = {
            n: { win: "你太兇了，我要殺了你！你一定下地獄，誰叫你要惹我", lose: "我贏了，所以我可以生氣！你看，阿簽就是很愛亂打小報告", draw: "你知道我爸爸是誰嗎？他是本校家長會長！竟然讓我平手，你死定了！" },
            h: { win: "阿簽，你打這什麼外掛？準備跟迎旗約談一小時", lose: "沒有人要理你，沒有人要跟你好，誰叫你打這麼菜", draw: "平手又不是你贏，你是有多厲害" },
            f: { win: "你真的很厲害，絕對可以撐過這段霸凌", lose: "沒關係！我永遠支持你", draw: "我們雙贏，這就是最好的結局" }
        };

        function startGame() {
            const docEl = document.documentElement;
            if (docEl.requestFullscreen) docEl.requestFullscreen();
            document.getElementById('story-overlay').style.display = 'none';
            switchView('normal');
        }

        function checkFullScreen() {
            if (!document.fullscreenElement && document.getElementById('story-overlay').style.display === 'none') {
                document.documentElement.requestFullscreen().catch(() => {});
            }
        }

        function switchView(type) {
            const layer = document.getElementById('transition-layer');
            layer.style.opacity = "1";
            setTimeout(() => {
                document.querySelectorAll('.game-content').forEach(el => el.classList.remove('active'));
                document.getElementById(`${type}-ver`).classList.add('active');
                initBoard(type);
                layer.style.opacity = "0";
            }, 800);
        }

        function initBoard(t) {
            const b = document.getElementById(`board-${t}`);
            b.innerHTML = '';
            state[t].board = Array(9).fill("");
            state[t].active = true;
            state[t].player = "O";
            for(let i=0; i<9; i++) {
                let c = document.createElement('div');
                c.className = 'cell';
                c.onclick = () => makeMove(t, i);
                b.appendChild(c);
            }
        }

        function makeMove(t, idx) {
            const g = state[t];
            if (!g.active || g.board[idx] !== "" || g.player !== "O") return;
            g.board[idx] = "O";
            render(t);
            if (checkEnd(t, "O")) return;
            g.player = "X";
            document.getElementById(`turn-${t}`).innerText = "輪到：對手 (X)";
            setTimeout(() => aiAction(t), 500);
        }

        function aiAction(t) {
            const g = state[t];
            let move = minimax(g.board, "X").index;
            if (move !== undefined) g.board[move] = "X";
            render(t);
            if (checkEnd(t, "X")) return;
            g.player = "O";
            document.getElementById(`turn-${t}`).innerText = "輪到：阿簽 (O)";
        }

        function checkEnd(t, p) {
            const g = state[t];
            let res = "";
            if (checkWin(g.board, p)) res = (p === "O" ? "win" : "lose");
            else if (g.board.every(c => c !== "")) res = "draw";

            if (res) {
                g.active = false;
                g.count++;
                showOverlay(msgs[t][res], t);
                return true;
            }
            return false;
        }

        function showOverlay(txt, t) {
            const ov = document.getElementById('overlay');
            const ot = document.getElementById('overlay-text');
            ot.innerText = txt;
            ot.style.color = (t === 'n' ? 'var(--accent-normal)' : (t === 'h' ? 'var(--accent-hard)' : 'var(--accent-friend)'));
            ov.style.display = 'flex';

            setTimeout(() => {
                ov.style.display = 'none';
                checkProgression(t);
            }, 5000);
        }

        function checkProgression(t) {
            // 第一階段完成：20場
            if (t === 'n' && state.n.count === 20) {
                document.getElementById('friend-btn').style.display = 'flex';
                initBoard('n');
            } 
            // 第二階段完成：30場
            else if (t === 'f' && state.f.count === 30) {
                alert("希悉郝謗：「看來他變強了，但這個程度還遠遠不及我，有種就跟我打啊！怕輸是不是？」");
                document.getElementById('friend-btn').onclick = null;
                document.getElementById('friend-btn').style.cursor = "default";
                switchView('hard');
            }
            // 第三階段完成：40場
            else if (t === 'h' && state.h.count === 40) {
                finalEnd();
            } else {
                initBoard(t);
            }
        }

        function finalEnd() {
            const ot = document.getElementById('overlay-text');
            ot.innerHTML = "「不是你怎麼都不生氣了？」<br>「好啦你贏了啦」<br><br><span style='color:white'>【希悉郝謗】已死亡</span><br>恭喜獲勝";
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('replay-btn').style.display = 'block';
            if (document.exitFullscreen) document.exitFullscreen();
        }

        function enterFriendMode() { switchView('f'); }
        function render(t) {
            const cells = document.querySelectorAll(`#board-${t} .cell`);
            state[t].board.forEach((v, i) => { cells[i].innerText = v; cells[i].style.color = (v==='X'?'#ff4d4d':'#fff'); });
        }

        function checkWin(b, p) { return [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]].some(c => b[c[0]]===p && b[c[1]]===p && b[c[2]]===p); }

        function minimax(b, p) {
            let avail = b.map((v, i) => v === "" ? i : null).filter(v => v !== null);
            if (checkWin(b, "O")) return { score: -10 };
            if (checkWin(b, "X")) return { score: 10 };
            if (avail.length === 0) return { score: 0 };
            let moves = [];
            for (let i of avail) {
                b[i] = p;
                let res = minimax(b, p === "X" ? "O" : "X");
                moves.push({ index: i, score: res.score });
                b[i] = "";
            }
            return p === "X" ? moves.reduce((a, b) => a.score > b.score ? a : b) : moves.reduce((a, b) => a.score < b.score ? a : b);
        }
    </script>
</body>
</html>
